{% extends 'base.html' %}

{% block title %}Health Snapshot - Biogram{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar pt-4">
            <nav class="nav flex-column">
                <a href="{% url 'dashboard' %}" class="sidebar-link active" data-testid="link-snapshot">üìä Health Snapshot</a>
                <a href="{% url 'health_timeline' %}" class="sidebar-link" data-testid="link-timeline">üìÖ Health Timeline</a>
                <a href="{% url 'wearable_insights' %}" class="sidebar-link" data-testid="link-wearable">‚åö Wearable Insights</a>
                <a href="{% url 'lab_results' %}" class="sidebar-link" data-testid="link-labs">üî¨ Lab Results</a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-10 pt-4 pb-5">
            <!-- Sticky Action Bar -->
            <div class="sticky-top bg-light pb-3 mb-4 border-bottom" style="top: 0; z-index: 100;">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">üß¨ Health Snapshot</h1>
                    <div>
                        <button class="btn btn-outline-primary me-2" data-testid="button-share">
                            üì§ Share with Provider
                        </button>
                        <button class="btn btn-primary" data-testid="button-prepare">
                            üìã Prepare for Appointment
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- AI-Generated Insights Section -->
            <section class="mb-5">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">ü§ñ AI-Generated Health Insights</h4>
                    </div>
                    <div class="card-body">
                        <!-- Health Trends -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">üìà Your Health Trends</h5>
                            <div class="row">
                                {% for trend in health_trends %}
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 {% if trend.severity == 'positive' %}border-success{% elif trend.severity == 'moderate' %}border-warning{% else %}border-info{% endif %}">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                {% if trend.severity == 'positive' %}‚úÖ{% elif trend.severity == 'moderate' %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif %}
                                                {{ trend.trend }}
                                            </h6>
                                            <p class="card-text small">{{ trend.description }}</p>
                                            <div class="alert {% if trend.severity == 'positive' %}alert-success{% elif trend.severity == 'moderate' %}alert-warning{% else %}alert-info{% endif %} py-2 px-3 small mb-0">
                                                <strong>Recommendation:</strong> {{ trend.recommendation }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Personalized Guidance -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">üí° Personalized Health Guidance</h5>
                            <div class="list-group">
                                {% for guidance in health_guidance %}
                                <div class="list-group-item">
                                    {{ guidance|safe }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Questions for Doctor -->
                        <div>
                            <h5 class="text-primary mb-3">‚ùì Important Questions for Your Next Doctor Visit</h5>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <ol class="mb-0">
                                        {% for question in doctor_questions %}
                                        <li class="mb-2">{{ question }}</li>
                                        {% endfor %}
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Active Problems with SOAP Summaries -->
            <section class="mb-5">
                <h3 class="mb-4">üè• Active Medical Problems</h3>
                
                {% for problem in active_problems %}
                <div class="card mb-3">
                    <div class="card-header {% if problem.status == 'Stable' %}bg-success-subtle{% elif problem.status == 'Improved' %}bg-info-subtle{% else %}bg-warning-subtle{% endif %}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ problem.problem }}</h5>
                            <div>
                                <span class="badge {% if problem.status == 'Stable' %}bg-success{% elif problem.status == 'Improved' %}bg-info{% else %}bg-warning{% endif %} me-2">
                                    {{ problem.status }}
                                </span>
                                <small class="text-muted">Since: {{ problem.onset }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="border-end h-100">
                                    <h6 class="text-uppercase small text-muted">Subjective</h6>
                                    <p class="small">{{ problem.soap_summary.subjective }}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end h-100">
                                    <h6 class="text-uppercase small text-muted">Objective</h6>
                                    <p class="small">{{ problem.soap_summary.objective }}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end h-100">
                                    <h6 class="text-uppercase small text-muted">Assessment</h6>
                                    <p class="small">{{ problem.soap_summary.assessment }}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-uppercase small text-muted">Plan</h6>
                                <p class="small">{{ problem.soap_summary.plan }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </section>
            
            <!-- Medications with Interactions and Side Effects -->
            <section class="mb-5">
                <h3 class="mb-4">üíä Current Medications</h3>
                
                <div class="row">
                    {% for med in medications %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-white">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-0">{{ med.name }}</h5>
                                        <p class="text-muted small mb-0">{{ med.dose }} - {{ med.frequency }}</p>
                                    </div>
                                    <span class="badge bg-primary">{{ med.purpose }}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Drug Interactions -->
                                {% if med.interactions %}
                                <div class="mb-3">
                                    <h6 class="text-danger mb-2">‚ö†Ô∏è Drug Interactions</h6>
                                    {% for interaction in med.interactions %}
                                    <div class="alert {% if interaction.severity == 'Moderate' %}alert-warning{% else %}alert-info{% endif %} py-2 px-3 mb-2 small">
                                        <strong>With {{ interaction.with }}:</strong> {{ interaction.description }}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <!-- Side Effects -->
                                <div>
                                    <h6 class="text-primary mb-2">üëÅÔ∏è Watch For These Side Effects</h6>
                                    <ul class="small mb-0">
                                        {% for effect in med.side_effects %}
                                        <li>{{ effect }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Highlight active sidebar link
    document.querySelectorAll('.sidebar-link').forEach(link => {
        if (link.href === window.location.href) {
            link.classList.add('active');
        }
    });
</script>
{% endblock %}
